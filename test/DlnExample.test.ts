import hre, { ethers } from 'hardhat';
import { expect, use } from 'chai';
import chaiBytes from 'chai-bytes';
import { DlnLibraryInvoker, DlnLibraryInvoker__factory } from '../typechain-types';

use(chaiBytes);

const Reward = 1000;
const Beneficiary = Buffer.alloc(32, 200);
const OrderGiveTokenAddress = Buffer.alloc(32, 100);
const OrderId = ethers.constants.MaxUint256;
const OrderTakeChainId = Buffer.alloc(32, 10);

describe('Use case: DLN', () => {
  let deployment: DlnLibraryInvoker;

  beforeEach(async () => {
    const [signer] = await hre.ethers.getSigners();
    deployment = await new DlnLibraryInvoker__factory(signer).deploy();
  });

  it('Should serialize init_wallet_if_needed ExternalInstruction on-chain', async () => {
    const resultHex = await deployment.getSerializedInitWalletIfNeededExternalInstruction(
      Reward,
      Beneficiary,
      OrderGiveTokenAddress,
    );

    const master = ethers.utils.arrayify(
      '0xe80300000000000001f01d1f0000000000000000000101000000000000000100000000000000010000008c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f8590300000000000000000000002000000000000000c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c800000000200000000000000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a9000000002000000000000000646464646464646464646464646464646464646464646464646464646464646400008c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f85906000000000000001968562fef0aab1b1d8f99d44306595cd4ba41d7cc899c007a774d23ad702ff601019f3d96f657370bf1dbb3313efba51ea7a08296ac33d77b949e1b62d538db37f20001c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c80000646464646464646464646464646464646464646464646464646464646464646400000000000000000000000000000000000000000000000000000000000000000000000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a90000010000000000000001',
    );

    expect(ethers.utils.arrayify(resultHex)).equalBytes(master);
  });

  it('Should serialize claim_order_unlock ExternalInstruction on-chain', async () => {
    const resultHex = await deployment.getSerializedClaimOrderUnlockExternalInstruction(
      Reward,
      Beneficiary,
      OrderId,
      OrderTakeChainId,
      OrderGiveTokenAddress,
    );

    const master = ethers.utils.arrayify(
      '0xe80300000000000000000000000107000000000000000200000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded01000000000000000000000005000000000000005354415445000300000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0100000000000000000000000a00000000000000464545204c4544474552000400000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded02000000000000000000000011000000000000004645455f4c45444745525f57414c4c45540000000020000000000000006464646464646464646464646464646464646464646464646464646464646464000600000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0200000000000000000000001000000000000000474956455f4f524445525f5354415445000000002000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000700000000000000010000008c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f8590300000000000000000000002000000000000000c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c800000000200000000000000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a90000000020000000000000006464646464646464646464646464646464646464646464646464646464646464000900000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0200000000000000000000001100000000000000474956455f4f524445525f57414c4c4554000000002000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000b00000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0200000000000000000000001800000000000000415554484f52495a45445f4e41544956455f53454e4445520000000020000000000000000a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a0a00000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0d0000000000000062584959deb8a728a91cebdc187b545d920479265052145f31fb80c73fac5aea00001968562fef0aab1b1d8f99d44306595cd4ba41d7cc899c007a774d23ad702ff60101f2250182dbb654414c597aa68671aedf4c362cea471a83827874f7e5fc5cc2310001565adba0294c79178f6d8f740ad91b150a16f3664ac6b662396196aa74a366f80001cbacf3203fa78ab924a40edaea6df7c61852ed302f39bc5a5570a13a0230f8b1000106a7d517187bd16635dad40455fdc2c0c124c68f215675a5dbbacb5f080000000000d36092a49b1e0128ac52dac1d2e12a9620c26355e6b0395f261f38573380100a00019f3d96f657370bf1dbb3313efba51ea7a08296ac33d77b949e1b62d538db37f20001c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8000164b38af2b249f349fb2d575069b8f66db033e0d50a7ecac5be7178a9ca0d08e600016464646464646464646464646464646464646464646464646464646464646464000013ee19b00dbd5580bc34492d838579bb743a2626308be4490dfa514d873e0234000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a9000028000000000000005951b44f8e9042fbffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff',
    );
    expect(ethers.utils.arrayify(resultHex)).equalBytes(master);
  });

  it('Should serialize init_wallet_if_needed ExternalInstruction on-chain', async () => {
    // this data is represented by the concatenation of first (init_wallet_if_needed)
    // and second (claim_order_unlock) instructions tested earlier. The only difference is in the chainId:
    // DlnBuilder uses current (hardhat's) chainId, which is 31337, so the instruction data has been slightly
    // modified to reflect this change
    const master = ethers.utils.arrayify(
      '0xe80300000000000001f01d1f0000000000000000000101000000000000000100000000000000010000008c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f8590300000000000000000000002000000000000000c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c800000000200000000000000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a9000000002000000000000000646464646464646464646464646464646464646464646464646464646464646400008c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f85906000000000000001968562fef0aab1b1d8f99d44306595cd4ba41d7cc899c007a774d23ad702ff601019f3d96f657370bf1dbb3313efba51ea7a08296ac33d77b949e1b62d538db37f20001c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c80000646464646464646464646464646464646464646464646464646464646464646400000000000000000000000000000000000000000000000000000000000000000000000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a90000010000000000000001e80300000000000000000000000107000000000000000200000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded01000000000000000000000005000000000000005354415445000300000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0100000000000000000000000a00000000000000464545204c4544474552000400000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded02000000000000000000000011000000000000004645455f4c45444745525f57414c4c45540000000020000000000000006464646464646464646464646464646464646464646464646464646464646464000600000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0200000000000000000000001000000000000000474956455f4f524445525f5354415445000000002000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000700000000000000010000008c97258f4e2489f1bb3d1029148e0d830b5a1399daff1084048e7bd8dbe9f8590300000000000000000000002000000000000000c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c800000000200000000000000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a90000000020000000000000006464646464646464646464646464646464646464646464646464646464646464000900000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0200000000000000000000001100000000000000474956455f4f524445525f57414c4c4554000000002000000000000000ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff000b00000000000000010000000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0200000000000000000000001800000000000000415554484f52495a45445f4e41544956455f53454e4445520000000020000000000000000000000000000000000000000000000000000000000000000000000000007a6900000d0720fe448de59d8811e24d6df917dc8d0d98b392ddf4dd2b622a747a60fded0d0000000000000062584959deb8a728a91cebdc187b545d920479265052145f31fb80c73fac5aea00001968562fef0aab1b1d8f99d44306595cd4ba41d7cc899c007a774d23ad702ff60101f2250182dbb654414c597aa68671aedf4c362cea471a83827874f7e5fc5cc2310001565adba0294c79178f6d8f740ad91b150a16f3664ac6b662396196aa74a366f80001cbacf3203fa78ab924a40edaea6df7c61852ed302f39bc5a5570a13a0230f8b1000106a7d517187bd16635dad40455fdc2c0c124c68f215675a5dbbacb5f080000000000d36092a49b1e0128ac52dac1d2e12a9620c26355e6b0395f261f38573380100a00019f3d96f657370bf1dbb3313efba51ea7a08296ac33d77b949e1b62d538db37f20001c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8c8000164b38af2b249f349fb2d575069b8f66db033e0d50a7ecac5be7178a9ca0d08e600016464646464646464646464646464646464646464646464646464646464646464000013ee19b00dbd5580bc34492d838579bb743a2626308be4490dfa514d873e0234000006ddf6e1d765a193d9cbe146ceeb79ac1cb485ed5f5b37913a8cf5857eff00a9000028000000000000005951b44f8e9042fbffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff',
    );

    const resultHex = await deployment.getSerializedClaimOrderUnlockExternalInstructionForOrder(
      Reward, // uint64 initReward,
      Reward, // uint64 claimUnlockReward,
      Beneficiary, // bytes32 unlockBeneficiary,
      OrderId, // uint256 orderId,
      {
        // DLN's order
        makerOrderNonce: 0,
        makerSrc: Buffer.alloc(32, 100),
        giveChainId: ethers.constants.MaxUint256,
        giveTokenAddress: OrderGiveTokenAddress,
        giveAmount: ethers.constants.MaxUint256,
        takeChainId: (await hre.ethers.provider.getNetwork()).chainId, // mind the current chainID
        takeTokenAddress: Buffer.alloc(32, 1),
        takeAmount: ethers.constants.MaxInt256,
        receiverDst: Buffer.alloc(33, 1),
        givePatchAuthoritySrc: Buffer.alloc(32, 100),
        orderAuthorityAddressDst: Buffer.alloc(32, 101),
        allowedTakerDst: '0x',
        allowedCancelBeneficiarySrc: '0x',
        externalCall: '0x',
      },
    );

    expect(ethers.utils.arrayify(resultHex)).equalBytes(master);
  });
});
